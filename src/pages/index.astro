---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/sections/Hero.astro';
import AboutPreview from '../components/sections/AboutPreview.astro';
import Services from '../components/sections/Services.astro';
import PortfolioPreview from '../components/sections/PortfolioPreview';
import Testimonials from '../components/sections/Testimonials.astro';
import InstagramGallery from '../components/sections/InstagramGallery.astro';
import CtaSection from '../components/sections/CtaSection.astro';
import { sanityClient } from '../lib/sanity';
import { impostazioniQuery, serviziQuery, recensioniQuery, eventiQuery } from '../lib/queries';

let impostazioni: any = null;
try {
  impostazioni = await sanityClient.fetch(impostazioniQuery);
} catch (e) {}

let servizi: any[] = [];
try {
  servizi = await sanityClient.fetch(serviziQuery);
} catch (e) {}

let recensioni: any[] = [];
try {
  recensioni = await sanityClient.fetch(recensioniQuery);
} catch (e) {}

let eventi: any[] = [];
try {
  eventi = await sanityClient.fetch(eventiQuery);
} catch (e) {}

const portfolioItems = eventi.length > 0 ? eventi.slice(0, 5).map((e: any, i: number) => ({
  id: i + 1,
  title: e.titolo,
  category: e.categoria || e.macroCategoria,
  filter: e.macroCategoria === 'wedding' ? 'matrimoni' : e.macroCategoria === 'celebrations' ? 'destination' : e.macroCategoria,
  location: e.location || '',
  image: e.immagineCopertina || undefined,
  span: i === 0,
})) : [];

const primaRecensione = recensioni.length > 0 ? {
  testo: recensioni[0].testo,
  autore: recensioni[0].autore,
  valutazione: recensioni[0].valutazione,
} : undefined;
---

<BaseLayout
  title="Wedding Planner Roma | Gaia Events — Matrimoni ed Eventi Esclusivi"
  description={impostazioni?.descrizione || 'Gaia Events — Wedding Planner & Event Manager a Roma. Esclusività e ricercatezza per il giorno più importante della tua vita.'}
>
  <main>
    <Hero
      eyebrow={impostazioni?.heroHomepage?.eyebrow}
      titolo={impostazioni?.heroHomepage?.titolo}
      sottotitolo={impostazioni?.heroHomepage?.sottotitolo}
      immagine={impostazioni?.heroHomepage?.immagine}
    />
    <AboutPreview
      eyebrow={impostazioni?.sezioneChiSono?.eyebrow}
      foto={impostazioni?.chiSono?.foto}
      titolo={impostazioni?.sezioneChiSono?.titolo || impostazioni?.chiSono?.titolo}
      testoPrincipale={impostazioni?.chiSono?.testoPrincipale}
      testoLink={impostazioni?.chiSono?.testoLink}
    />
    <Services servizi={servizi} eyebrow={impostazioni?.sezioneServizi?.eyebrow} titolo={impostazioni?.sezioneServizi?.titolo} />
    <PortfolioPreview client:visible items={portfolioItems} eyebrow={impostazioni?.sezionePortfolio?.eyebrow} titolo={impostazioni?.sezionePortfolio?.titolo} />
    <Testimonials recensione={primaRecensione} />
    <InstagramGallery />
    <CtaSection eyebrow={impostazioni?.sezioneCta?.eyebrow} titolo={impostazioni?.sezioneCta?.titolo} descrizione={impostazioni?.sezioneCta?.descrizione} testoBottone={impostazioni?.sezioneCta?.testoBottone} linkBottone={impostazioni?.sezioneCta?.linkBottone} />
  </main>
</BaseLayout>
