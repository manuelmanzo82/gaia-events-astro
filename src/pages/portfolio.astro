---
import BaseLayout from '../layouts/BaseLayout.astro';
import PortfolioPreview from '../components/sections/PortfolioPreview';
import CtaSection from '../components/sections/CtaSection.astro';
import { sanityClient } from '../lib/sanity';
import { impostazioniQuery, eventiQuery } from '../lib/queries';

let impostazioni: any = null;
try {
  impostazioni = await sanityClient.fetch(impostazioniQuery);
} catch (e) {}

let eventi: any[] = [];
try {
  eventi = await sanityClient.fetch(eventiQuery);
} catch (e) {}

const pp = impostazioni?.paginaPortfolio;
const cat = impostazioni?.portfolioCategorie;

// Filter events by category
const weddingEventi = eventi.filter((e: any) => e.macroCategoria === 'wedding');
const corporateEventi = eventi.filter((e: any) => e.macroCategoria === 'corporate');
const celebrationEventi = eventi.filter((e: any) => e.macroCategoria === 'celebrations');

// Default items
const defaultWedding = [
  { titolo: 'Sara & Marco', categoria: 'Destination Wedding', location: 'Villa Cetinale, Toscana', immagineCopertina: null as string | null },
  { titolo: 'Giulia & Alessandro', categoria: 'Matrimonio', location: 'Borgo Egnazia, Puglia', immagineCopertina: null as string | null },
  { titolo: 'Elena & Francesco', categoria: 'Matrimonio', location: 'Ravello, Costiera Amalfitana', immagineCopertina: null as string | null },
];
const defaultCorporate = { titolo: 'Corporate Gala', categoria: 'Gala Dinner', location: 'Palazzo Brancaccio, Roma', immagineCopertina: null as string | null };
const defaultCelebration = { titolo: 'Festa Privata', categoria: 'Anniversario', location: 'Villa Borghese, Roma', immagineCopertina: null as string | null };

const weddingItems = weddingEventi.length >= 3 ? weddingEventi.slice(0, 3) : defaultWedding;
const corporateItem = corporateEventi.length > 0 ? corporateEventi[0] : defaultCorporate;
const celebrationItem = celebrationEventi.length > 0 ? celebrationEventi[0] : defaultCelebration;

// For PortfolioPreview component
const portfolioItems = eventi.length > 0 ? eventi.map((e: any, i: number) => ({
  id: i + 1,
  title: e.titolo,
  category: e.categoria || e.macroCategoria,
  filter: e.macroCategoria === 'wedding' ? 'matrimoni' : e.macroCategoria === 'corporate' ? 'corporate' : 'destination',
  location: e.location || '',
  image: e.immagineCopertina || undefined,
  span: i === 0,
  slug: e.slug?.current || '',
  hasVideo: !!e.videoUrl,
})) : [];
---

<BaseLayout title="Portfolio" description="Scopri gli eventi realizzati da Gaia Events — Matrimoni, Corporate Events e Destination Wedding.">
  <main>
    <!-- Hero -->
    <section data-navbar-theme="dark" class="relative h-[60vh] min-h-[400px] flex items-center justify-center overflow-hidden">
      <div class="absolute inset-0 bg-charcoal">
        {pp?.heroImmagine ? (
          <img src={pp.heroImmagine} alt="" class="absolute inset-0 w-full h-full object-cover" />
        ) : (
          <div class="absolute inset-0 flex items-center justify-center">
            <span class="text-white/10 text-xl tracking-widest uppercase select-none">Hero Background Image</span>
          </div>
        )}
      </div>
      <div class="absolute inset-0 bg-gradient-to-b from-charcoal/50 to-charcoal/70"></div>
      <div class="relative z-10 text-center px-6 mt-12">
        <p class="font-sans text-[0.8rem] tracking-[0.35em] uppercase text-gold mb-5">Portfolio</p>
        <h1 class="text-[clamp(2.2rem,6vw,4rem)] font-light text-white leading-[1.15] mb-4">{pp?.heroTitolo || 'Storie ed Emozioni'}</h1>
        <p class="font-sans text-[0.95rem] font-light text-white/80 max-w-[28rem] mx-auto">
          {pp?.heroSottotitolo || 'Ogni evento racconta una storia unica. Scoprite alcuni dei momenti magici creati per i miei clienti.'}
        </p>
      </div>
      <div class="absolute bottom-8 left-1/2 -translate-x-1/2 z-10">
        <div class="w-[1.4rem] h-[2.2rem] border-2 border-white/50 rounded-full flex items-start justify-center pt-1.5">
          <div class="w-1 h-1 rounded-full bg-gold animate-bounce"></div>
        </div>
      </div>
    </section>

    <!-- Matrimoni — Hero Section (dominant) -->
    <section data-navbar-theme="light" class="py-20 px-6">
      <div class="max-w-[1150px] mx-auto">
        <div class="text-center mb-14 fade-in">
          <p class="font-sans text-[0.7rem] tracking-[0.2em] uppercase text-gold mb-4">{cat?.wedding?.titolo ? '' : 'La Nostra Specialità'}</p>
          <h2 class="font-serif text-[clamp(1.8rem,4vw,2.8rem)] font-normal text-charcoal mb-4">{cat?.wedding?.titolo || 'Matrimoni'}</h2>
          <p class="font-sans text-[0.95rem] font-light text-charcoal/60 max-w-[28rem] mx-auto">
            {cat?.wedding?.descrizione || 'Matrimoni indimenticabili, curati in ogni dettaglio. Dal primo incontro fino all\'ultimo ballo.'}
          </p>
        </div>
        <!-- 2-column grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:h-[600px] lg:h-[70vh] lg:max-h-[750px]">
          <!-- Main large image -->
          <a href={weddingItems[0]?.slug?.current ? `/portfolio/${weddingItems[0].slug.current}` : '/portfolio'} class="fade-in group relative aspect-[3/4] md:aspect-auto md:h-full rounded-[3px] overflow-hidden block">
            {weddingItems[0]?.immagineCopertina ? (
              <img src={weddingItems[0].immagineCopertina} alt={weddingItems[0].titolo} class="absolute inset-0 w-full h-full object-cover" />
            ) : (
              <div class="absolute inset-0 bg-beige flex items-center justify-center">
                <span class="text-charcoal/15 text-sm tracking-widest uppercase select-none">{weddingItems[0].titolo}</span>
              </div>
            )}
            <div class="absolute inset-0 bg-gradient-to-t from-charcoal/70 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
            <div class="absolute bottom-0 left-0 right-0 p-8 translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-500">
              <p class="font-sans text-[0.65rem] tracking-[0.15em] uppercase text-gold mb-2">{weddingItems[0].categoria}</p>
              <h3 class="font-serif text-[1.4rem] text-white mb-1">{weddingItems[0].titolo}</h3>
              <p class="font-sans text-[0.8rem] text-white/60">{weddingItems[0].location}</p>
            </div>
          </a>
          <!-- Right column: 2 images stacked -->
          <div class="flex flex-col gap-4 md:h-full">
            {[weddingItems[1], weddingItems[2]].map((item: any) => (
              <a href={item?.slug?.current ? `/portfolio/${item.slug.current}` : '/portfolio'} class="fade-in group relative aspect-[4/3] md:aspect-auto md:flex-1 rounded-[3px] overflow-hidden block">
                {item?.immagineCopertina ? (
                  <img src={item.immagineCopertina} alt={item.titolo} class="absolute inset-0 w-full h-full object-cover" />
                ) : (
                  <div class="absolute inset-0 bg-beige flex items-center justify-center">
                    <span class="text-charcoal/15 text-sm tracking-widest uppercase select-none">{item.titolo}</span>
                  </div>
                )}
                <div class="absolute inset-0 bg-gradient-to-t from-charcoal/70 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                <div class="absolute bottom-0 left-0 right-0 p-6 translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-500">
                  <p class="font-sans text-[0.65rem] tracking-[0.15em] uppercase text-gold mb-2">{item.categoria}</p>
                  <h3 class="font-serif text-[1.2rem] text-white mb-1">{item.titolo}</h3>
                  <p class="font-sans text-[0.75rem] text-white/60">{item.location}</p>
                </div>
              </a>
            ))}
          </div>
        </div>
      </div>
    </section>

    <!-- Eventi Aziendali & Feste Private -->
    <section data-navbar-theme="light" class="pb-20 px-6">
      <div class="max-w-[1150px] mx-auto grid grid-cols-1 md:grid-cols-2 gap-12">
        <!-- Eventi Aziendali -->
        <div class="fade-in">
          <div class="mb-6">
            <p class="font-sans text-[0.65rem] tracking-[0.15em] uppercase text-sage mb-2">Corporate</p>
            <h3 class="font-serif text-[1.5rem] text-charcoal mb-2">{cat?.corporate?.titolo || 'Eventi Aziendali'}</h3>
            <p class="font-sans text-[0.85rem] font-light text-charcoal/60 leading-relaxed">
              {cat?.corporate?.descrizione || 'Conferenze, gala dinner, team building e celebrazioni corporate che lasciano il segno.'}
            </p>
          </div>
          <a href={corporateItem?.slug?.current ? `/portfolio/${corporateItem.slug.current}` : '/portfolio'} class="group relative aspect-[16/10] rounded-[3px] overflow-hidden block">
            {(cat?.corporate?.immagineCopertina || corporateItem.immagineCopertina) ? (
              <img src={cat?.corporate?.immagineCopertina || corporateItem.immagineCopertina} alt={corporateItem.titolo} class="absolute inset-0 w-full h-full object-cover" />
            ) : (
              <div class="absolute inset-0 bg-beige flex items-center justify-center">
                <span class="text-charcoal/15 text-sm tracking-widest uppercase select-none">Corporate Event</span>
              </div>
            )}
            <div class="absolute inset-0 bg-gradient-to-t from-charcoal/70 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
            <div class="absolute bottom-0 left-0 right-0 p-6 translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-500">
              <p class="font-sans text-[0.65rem] tracking-[0.15em] uppercase text-gold mb-2">{corporateItem.categoria}</p>
              <h3 class="font-serif text-[1.2rem] text-white mb-1">{corporateItem.titolo}</h3>
              <p class="font-sans text-[0.75rem] text-white/60">{corporateItem.location}</p>
            </div>
          </a>
        </div>

        <!-- Feste Private -->
        <div class="fade-in">
          <div class="mb-6">
            <p class="font-sans text-[0.65rem] tracking-[0.15em] uppercase text-sage mb-2">Celebrations</p>
            <h3 class="font-serif text-[1.5rem] text-charcoal mb-2">{cat?.celebrations?.titolo || 'Feste Private'}</h3>
            <p class="font-sans text-[0.85rem] font-light text-charcoal/60 leading-relaxed">
              {cat?.celebrations?.descrizione || 'Compleanni speciali, battesimi e anniversari. Ogni celebrazione merita di essere indimenticabile.'}
            </p>
          </div>
          <a href={celebrationItem?.slug?.current ? `/portfolio/${celebrationItem.slug.current}` : '/portfolio'} class="group relative aspect-[16/10] rounded-[3px] overflow-hidden block">
            {(cat?.celebrations?.immagineCopertina || celebrationItem.immagineCopertina) ? (
              <img src={cat?.celebrations?.immagineCopertina || celebrationItem.immagineCopertina} alt={celebrationItem.titolo} class="absolute inset-0 w-full h-full object-cover" />
            ) : (
              <div class="absolute inset-0 bg-beige flex items-center justify-center">
                <span class="text-charcoal/15 text-sm tracking-widest uppercase select-none">Private Party</span>
              </div>
            )}
            <div class="absolute inset-0 bg-gradient-to-t from-charcoal/70 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
            <div class="absolute bottom-0 left-0 right-0 p-6 translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-500">
              <p class="font-sans text-[0.65rem] tracking-[0.15em] uppercase text-gold mb-2">{celebrationItem.categoria}</p>
              <h3 class="font-serif text-[1.2rem] text-white mb-1">{celebrationItem.titolo}</h3>
              <p class="font-sans text-[0.75rem] text-white/60">{celebrationItem.location}</p>
            </div>
          </a>
        </div>
      </div>
    </section>

    <!-- Portfolio Grid with Filters -->
    <PortfolioPreview client:visible items={portfolioItems} />

    <!-- CTA -->
    <section data-navbar-theme="dark" class="relative py-28 px-6 overflow-hidden">
      <div class="absolute inset-0 bg-charcoal"></div>
      <div class="absolute inset-0 bg-bordeaux/88"></div>
      <div class="relative z-10 max-w-[600px] mx-auto text-center">
        <p class="font-sans text-[0.7rem] tracking-[0.25em] uppercase text-gold mb-5">
          Il Tuo Evento
        </p>
        <h2 class="font-serif text-[clamp(1.8rem,4.5vw,2.8rem)] font-light text-white leading-[1.2] mb-6">
          Vuoi Vedere il Tuo<br /><em class="italic">Evento Qui?</em>
        </h2>
        <p class="font-sans text-[0.95rem] font-light text-white/80 max-w-[26rem] mx-auto mb-10">
          Raccontami la tua visione e insieme creeremo qualcosa di indimenticabile
        </p>
        <a
          href="/preventivo"
          class="inline-block font-sans text-[0.75rem] tracking-[0.18em] uppercase px-9 py-4 bg-gold text-charcoal hover:bg-white transition-all duration-300"
        >
          Parliamone Insieme
        </a>
      </div>
    </section>
  </main>
</BaseLayout>
