---
import { sanityClient } from '../../lib/sanity';
import { instagramGalleryQuery } from '../../lib/queries';

const igProfileUrl = 'https://www.instagram.com/gaiacrognale_events/';

interface IgItem {
  url: string;
  mediaType?: 'foto' | 'video';
  caption?: string;
  instagramUrl?: string;
}

let images: IgItem[] = [];
try {
  const data = await sanityClient.fetch(instagramGalleryQuery);
  if (data?.immagini) {
    images = data.immagini.slice(-8).reverse();
  }
} catch (e) {
  // Sanity fetch failed, fallback to placeholders
}

const igSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><circle cx="12" cy="12" r="4"/><circle cx="17.5" cy="6.5" r="0.5" fill="currentColor" stroke="none"/></svg>';

const igBtnSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><circle cx="12" cy="12" r="4"/><circle cx="17.5" cy="6.5" r="0.5" fill="currentColor" stroke="none"/></svg>';

const playSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48" fill="none"><circle cx="24" cy="24" r="23" fill="rgba(0,0,0,0.35)" stroke="white" stroke-width="1.5"/><polygon points="19,14 19,34 35,24" fill="white"/></svg>';

const placeholderCount = 8;
const showPlaceholders = images.length === 0;
---

<section data-navbar-theme="light" class="py-20 px-6">
  <div class="max-w-[1150px] mx-auto">
    <!-- Header -->
    <div class="text-center mb-12 fade-in">
      <p class="font-sans text-[0.7rem] tracking-[0.2em] uppercase text-gold mb-4">
        Seguimi su Instagram
      </p>
      <a
        href={igProfileUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="font-serif text-[clamp(1.6rem,4vw,2.5rem)] font-normal text-charcoal hover:text-bordeaux transition-colors duration-300"
      >
        @gaiacrognale_events
      </a>
    </div>

    <!-- Grid -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 fade-in">
      {showPlaceholders ? (
        Array.from({ length: placeholderCount }).map((_, i) => (
          <a
            href={igProfileUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="group relative aspect-[4/5] rounded-[3px] overflow-hidden block bg-beige"
          >
            <div class="absolute inset-0 flex items-center justify-center text-charcoal/15">
              <Fragment set:html={igSvg} />
            </div>
            <div class="absolute inset-0 bg-charcoal/0 group-hover:bg-charcoal/50 transition-all duration-400 flex items-center justify-center">
              <div class="text-white opacity-0 group-hover:opacity-100 transition-opacity duration-400">
                <Fragment set:html={igSvg} />
              </div>
            </div>
          </a>
        ))
      ) : (
        images.map((img) => (
          <a
            href={img.instagramUrl || igProfileUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="group relative aspect-[4/5] rounded-[3px] overflow-hidden block"
          >
            <img
              src={img.url}
              alt={img.caption || 'Instagram post'}
              class="w-full h-full object-cover"
              loading="lazy"
            />
            {img.mediaType === 'video' && (
              <div class="ig-play absolute inset-0 flex items-center justify-center pointer-events-none">
                <Fragment set:html={playSvg} />
              </div>
            )}
            <div class="absolute inset-0 bg-charcoal/0 group-hover:bg-charcoal/55 transition-all duration-400 flex flex-col items-center justify-center gap-3">
              <div class="text-white opacity-0 group-hover:opacity-100 transition-opacity duration-400">
                <Fragment set:html={img.mediaType === 'video' ? playSvg : igSvg} />
              </div>
              {img.caption && (
                <p class="text-white text-center font-sans text-[0.75rem] font-light leading-relaxed px-4 max-w-[90%] opacity-0 group-hover:opacity-100 transition-opacity duration-400 line-clamp-2">
                  {img.caption}
                </p>
              )}
            </div>
          </a>
        ))
      )}
    </div>

    <!-- CTA Button -->
    <div class="text-center mt-12 fade-in">
      <a
        href={igProfileUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center gap-3 font-sans text-[0.75rem] tracking-[0.18em] uppercase px-9 py-4 border border-gold text-gold hover:bg-gold hover:text-charcoal transition-all duration-300"
      ><Fragment set:html={igBtnSvg} />Seguimi su Instagram</a>
    </div>
  </div>
</section>

<style>
  .ig-play {
    transition: opacity 0.3s ease;
  }
  .group:hover .ig-play {
    opacity: 0;
  }
</style>
