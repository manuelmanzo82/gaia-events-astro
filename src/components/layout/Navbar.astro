---
import { sanityClient } from '../../lib/sanity';

let logo: string | undefined;
try {
  const data = await sanityClient.fetch(`*[_type == "impostazioni"][0]{ "logo": logo.asset->url + "?w=400&fm=webp&q=90" }`);
  logo = data?.logo;
} catch (e) {
  // Sanity fetch failed, logo will fallback to text
}

const navLinks = [
  { href: '/chi-sono', label: 'Chi Sono' },
  { href: '/servizi', label: 'Servizi' },
  { href: '/portfolio', label: 'Portfolio' },
  { href: '/blog', label: 'Blog' },
  { href: '/preventivo', label: 'Preventivo' },
  { href: '/contatti', label: 'Contatti' },
];
---

<header id="navbar" class="fixed top-0 left-0 right-0 z-50 pt-4 lg:pt-6 transition-colors duration-500">
  <nav class="max-w-[1280px] mx-auto px-4 lg:px-6 flex items-center justify-between">
    <!-- Logo -->
    <a
      href="/"
      id="navbar-logo"
      class="navbar-themed font-serif text-[1.4rem] font-medium tracking-[0.12em] transition-colors duration-500"
    >
      {logo ? (
        <img id="navbar-logo-img" src={logo} alt="Gaia Events" width="231" height="152" class="h-[80px] lg:h-[130px] w-auto object-contain transition-[filter] duration-500" />
      ) : (
        'GAIA EVENTS'
      )}
    </a>

    <!-- Desktop Nav -->
    <ul class="hidden lg:flex items-center gap-9">
      {navLinks.map((link) => (
        <li>
          <a
            href={link.href}
            class="navbar-themed font-sans text-[0.8rem] tracking-[0.12em] uppercase transition-colors duration-500 hover:opacity-70"
          >
            {link.label}
          </a>
        </li>
      ))}
    </ul>

    <!-- Mobile Menu Button -->
    <button
      id="mobile-menu-btn"
      type="button"
      class="lg:hidden navbar-themed font-sans text-[0.65rem] tracking-[0.18em] uppercase border border-current px-4 py-2 transition-colors duration-500"
      aria-label="Apri menu"
      aria-expanded="false"
    >
      Menu
    </button>
  </nav>
</header>

<!-- Mobile Menu Overlay (z-[60] to sit above navbar z-50) -->
<div
  id="mobile-menu"
  class="fixed inset-0 bg-ivory z-[60] flex flex-col translate-x-full transition-transform duration-400 ease-in-out"
>
  <div class="flex items-center justify-between px-4 pt-4">
    <a href="/" class="font-serif text-[1.4rem] font-medium tracking-[0.12em] text-charcoal">
      {logo ? (
        <img id="mobile-menu-logo-img" src={logo} alt="Gaia Events" width="231" height="152" class="h-[80px] w-auto object-contain" />
      ) : (
        'GAIA EVENTS'
      )}
    </a>
    <button
      id="mobile-menu-close"
      type="button"
      class="relative w-10 h-10 flex items-center justify-center cursor-pointer"
      aria-label="Chiudi menu"
    >
      <span class="block absolute h-[1.5px] w-6 bg-charcoal rotate-45 pointer-events-none"></span>
      <span class="block absolute h-[1.5px] w-6 bg-charcoal -rotate-45 pointer-events-none"></span>
    </button>
  </div>

  <nav class="flex-1 flex flex-col items-center justify-center gap-8">
    {navLinks.map((link) => (
      <a
        href={link.href}
        class="mobile-nav-link font-serif text-3xl text-charcoal hover:text-bordeaux transition-colors duration-300"
      >
        {link.label}
      </a>
    ))}
    <a
      href="/en/destination-wedding"
      class="mobile-nav-link inline-flex items-center gap-2 font-sans text-[0.85rem] tracking-[0.15em] uppercase text-gold hover:text-bordeaux transition-colors duration-300"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><path d="M2 12h20"/></svg>
      Destination Wedding
    </a>
    <a
      href="/preventivo"
      class="mt-6 inline-block bg-gold text-charcoal font-sans text-[0.75rem] tracking-[0.15em] uppercase px-10 py-4 hover:bg-gold/90 transition-colors duration-300"
    >
      Parliamone Insieme
    </a>
    <!-- Social Icons -->
    <div class="flex items-center gap-5 mt-8">
      <a href="https://wa.me/393273855362" target="_blank" rel="noopener noreferrer" class="text-charcoal/40 hover:text-gold transition-colors duration-300" aria-label="WhatsApp">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
      </a>
      <a href="https://www.instagram.com/gaiacrognale_events/" target="_blank" rel="noopener noreferrer" class="text-charcoal/40 hover:text-gold transition-colors duration-300" aria-label="Instagram">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><circle cx="12" cy="12" r="4"/><circle cx="17.5" cy="6.5" r="0.5" fill="currentColor" stroke="none"/></svg>
      </a>
      <a href="https://www.facebook.com/GaiaCrognaleEventi" target="_blank" rel="noopener noreferrer" class="text-charcoal/40 hover:text-gold transition-colors duration-300" aria-label="Facebook">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
      </a>
    </div>
  </nav>
</div>

<!-- Inline script: theme switching + mobile menu -->
<script is:inline>
  (function() {
    var mobileMenuOpen = false;

    // ─── Theme switching ───
    function applyNavbarTheme() {
      var items = document.querySelectorAll('.navbar-themed');
      var sections = document.querySelectorAll('[data-navbar-theme]');
      var logoImg = document.getElementById('navbar-logo-img');
      var navbarHeight = 112;
      var currentTheme = 'light';

      for (var i = 0; i < sections.length; i++) {
        var rect = sections[i].getBoundingClientRect();
        if (rect.top <= navbarHeight && rect.bottom > navbarHeight) {
          currentTheme = sections[i].getAttribute('data-navbar-theme') || 'light';
        }
      }

      for (var j = 0; j < items.length; j++) {
        if (currentTheme === 'dark') {
          items[j].classList.remove('text-charcoal');
          items[j].classList.add('text-ivory');
        } else {
          items[j].classList.remove('text-ivory');
          items[j].classList.add('text-charcoal');
        }
      }

      // Don't apply invert filter when mobile menu is open (logo should stay dark)
      if (logoImg) {
        if (mobileMenuOpen) {
          logoImg.style.filter = 'none';
        } else {
          logoImg.style.filter = currentTheme === 'dark' ? 'brightness(0) invert(1)' : 'none';
        }
      }
    }

    applyNavbarTheme();
    window.addEventListener('scroll', applyNavbarTheme, { passive: true });
    document.addEventListener('astro:page-load', applyNavbarTheme);
    document.addEventListener('DOMContentLoaded', applyNavbarTheme);

    // ─── Mobile menu ───
    function initMobileMenu() {
      var menuBtn = document.getElementById('mobile-menu-btn');
      var menuClose = document.getElementById('mobile-menu-close');
      var mobileMenu = document.getElementById('mobile-menu');

      if (!menuBtn || !mobileMenu) return;

      // Prevent double-init
      if (menuBtn.dataset.init) return;
      menuBtn.dataset.init = '1';

      function openMenu() {
        mobileMenuOpen = true;
        mobileMenu.classList.remove('translate-x-full');
        mobileMenu.classList.add('translate-x-0');
        menuBtn.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
        // Force navbar logo to dark (no invert) while menu is open
        var logoImg = document.getElementById('navbar-logo-img');
        if (logoImg) logoImg.style.filter = 'none';
      }

      function closeMenu() {
        mobileMenuOpen = false;
        mobileMenu.classList.add('translate-x-full');
        mobileMenu.classList.remove('translate-x-0');
        menuBtn.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        // Re-apply theme-based filter
        applyNavbarTheme();
      }

      menuBtn.addEventListener('click', openMenu);

      if (menuClose) {
        menuClose.addEventListener('click', function(e) {
          e.stopPropagation();
          closeMenu();
        });
      }

      // Close on nav link click (use event delegation on the menu)
      mobileMenu.addEventListener('click', function(e) {
        var target = e.target.closest('a');
        if (target) closeMenu();
      });
    }

    // Run on DOMContentLoaded and astro:page-load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMobileMenu);
    } else {
      initMobileMenu();
    }
    document.addEventListener('astro:page-load', initMobileMenu);
  })();
</script>
