---
interface Props {
  logo?: string;
}

const { logo } = Astro.props;

const navLinks = [
  { href: '/chi-sono', label: 'Chi Sono' },
  { href: '/servizi', label: 'Servizi' },
  { href: '/portfolio', label: 'Portfolio' },
  { href: '/dicono-di-me', label: 'Dicono di Me' },
  { href: '/contatti', label: 'Contatti' },
  { href: '/preventivo', label: 'Preventivo' },
];
---

<header id="navbar" class="fixed top-0 left-0 right-0 z-50 pt-4 lg:pt-6 transition-colors duration-500">
  <nav class="max-w-[1280px] mx-auto px-4 lg:px-6 flex items-center justify-between">
    <!-- Logo -->
    <a
      href="/"
      id="navbar-logo"
      class="navbar-themed font-serif text-[1.4rem] font-medium tracking-[0.12em] transition-colors duration-500"
    >
      {logo ? (
        <img id="navbar-logo-img" src={logo} alt="Gaia Events" class="h-[80px] lg:h-[130px] w-auto object-contain transition-[filter] duration-500" />
      ) : (
        'GAIA EVENTS'
      )}
    </a>

    <!-- Desktop Nav -->
    <ul class="hidden lg:flex items-center gap-9">
      {navLinks.map((link) => (
        <li>
          <a
            href={link.href}
            class="navbar-themed font-sans text-[0.8rem] tracking-[0.12em] uppercase transition-colors duration-500 hover:opacity-70"
          >
            {link.label}
          </a>
        </li>
      ))}
    </ul>

    <!-- Mobile Menu Button -->
    <button
      id="mobile-menu-btn"
      type="button"
      class="navbar-themed lg:hidden font-sans text-[0.65rem] tracking-[0.15em] uppercase border border-current px-4 py-2 transition-colors duration-500"
      aria-label="Apri menu"
      aria-expanded="false"
    >
      Menu
    </button>
  </nav>
</header>

<!-- Mobile Menu Overlay -->
<div
  id="mobile-menu"
  class="fixed inset-0 bg-ivory z-40 flex flex-col opacity-0 pointer-events-none transition-opacity duration-300"
>
  <div class="flex items-center justify-between px-4 pt-6 h-[calc(1.5rem+4rem)]">
    <a href="/" class="font-serif text-[1.4rem] font-medium tracking-[0.12em] text-charcoal">
      {logo ? (
        <img id="mobile-menu-logo-img" src={logo} alt="Gaia Events" class="h-[80px] w-auto object-contain" />
      ) : (
        'GAIA EVENTS'
      )}
    </a>
    <button
      id="mobile-menu-close"
      type="button"
      class="font-sans text-[0.65rem] tracking-[0.15em] uppercase border border-charcoal px-4 py-2 text-charcoal"
      aria-label="Chiudi menu"
    >
      Chiudi
    </button>
  </div>

  <nav class="flex-1 flex flex-col items-center justify-center gap-8">
    {navLinks.map((link) => (
      <a
        href={link.href}
        class="mobile-nav-link font-serif text-3xl text-charcoal hover:text-bordeaux transition-colors duration-300"
      >
        {link.label}
      </a>
    ))}
    <a
      href="/contatti"
      class="mt-6 inline-block bg-gold text-charcoal font-sans text-[0.75rem] tracking-[0.15em] uppercase px-10 py-4 hover:bg-gold/90 transition-colors duration-300"
    >
      Richiedi Preventivo
    </a>
  </nav>
</div>

<!-- Inline script that runs IMMEDIATELY to prevent flash of wrong colors -->
<script is:inline>
  (function() {
    function applyNavbarTheme() {
      var items = document.querySelectorAll('.navbar-themed');
      var sections = document.querySelectorAll('[data-navbar-theme]');
      var logoImg = document.getElementById('navbar-logo-img');
      var navbarHeight = 112;
      var currentTheme = 'light';

      for (var i = 0; i < sections.length; i++) {
        var rect = sections[i].getBoundingClientRect();
        if (rect.top <= navbarHeight && rect.bottom > navbarHeight) {
          currentTheme = sections[i].getAttribute('data-navbar-theme') || 'light';
        }
      }

      for (var j = 0; j < items.length; j++) {
        if (currentTheme === 'dark') {
          items[j].classList.remove('text-charcoal');
          items[j].classList.add('text-ivory');
        } else {
          items[j].classList.remove('text-ivory');
          items[j].classList.add('text-charcoal');
        }
      }

      // Apply filter to logo image for dark/light sections
      if (logoImg) {
        logoImg.style.filter = currentTheme === 'dark' ? 'brightness(0) invert(1)' : 'none';
      }
    }

    // Run immediately
    applyNavbarTheme();

    // Run on scroll
    window.addEventListener('scroll', applyNavbarTheme, { passive: true });

    // Run again after Astro page transitions
    document.addEventListener('astro:page-load', applyNavbarTheme);
    // Also after DOM is fully ready
    document.addEventListener('DOMContentLoaded', applyNavbarTheme);
  })();
</script>

<script>
  document.addEventListener('astro:page-load', () => {
    // --- Mobile menu ---
    const menuBtn = document.getElementById('mobile-menu-btn');
    const menuClose = document.getElementById('mobile-menu-close');
    const mobileMenu = document.getElementById('mobile-menu');

    function openMenu() {
      if (!mobileMenu || !menuBtn) return;
      mobileMenu.classList.remove('opacity-0', 'pointer-events-none');
      mobileMenu.classList.add('opacity-100', 'pointer-events-auto');
      menuBtn.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      if (!mobileMenu || !menuBtn) return;
      mobileMenu.classList.add('opacity-0', 'pointer-events-none');
      mobileMenu.classList.remove('opacity-100', 'pointer-events-auto');
      menuBtn.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
    }

    menuBtn?.addEventListener('click', openMenu);
    menuClose?.addEventListener('click', closeMenu);
    mobileMenu?.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', closeMenu);
    });
  });
</script>
