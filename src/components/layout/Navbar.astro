---
interface Props {
  logo?: string;
}

const { logo } = Astro.props;

const navLinks = [
  { href: '/chi-sono', label: 'Chi Sono' },
  { href: '/servizi', label: 'Servizi' },
  { href: '/portfolio', label: 'Portfolio' },
  { href: '/dicono-di-me', label: 'Dicono di Me' },
  { href: '/contatti', label: 'Contatti' },
  { href: '/preventivo', label: 'Preventivo' },
];
---

<header id="navbar" class="fixed top-0 left-0 right-0 z-50 pt-4 lg:pt-6 transition-colors duration-500">
  <nav class="max-w-[1280px] mx-auto px-4 lg:px-6 flex items-center justify-between">
    <!-- Logo -->
    <a
      href="/"
      id="navbar-logo"
      class="navbar-themed font-serif text-[1.4rem] font-medium tracking-[0.12em] transition-colors duration-500"
    >
      {logo ? (
        <img id="navbar-logo-img" src={logo} alt="Gaia Events" class="h-[80px] lg:h-[130px] w-auto object-contain transition-[filter] duration-500" />
      ) : (
        'GAIA EVENTS'
      )}
    </a>

    <!-- Desktop Nav -->
    <ul class="hidden lg:flex items-center gap-9">
      {navLinks.map((link) => (
        <li>
          <a
            href={link.href}
            class="navbar-themed font-sans text-[0.8rem] tracking-[0.12em] uppercase transition-colors duration-500 hover:opacity-70"
          >
            {link.label}
          </a>
        </li>
      ))}
    </ul>

    <!-- Mobile Menu Button -->
    <button
      id="mobile-menu-btn"
      type="button"
      class="lg:hidden navbar-themed font-sans text-[0.65rem] tracking-[0.18em] uppercase border border-current px-4 py-2 transition-colors duration-500"
      aria-label="Apri menu"
      aria-expanded="false"
    >
      Menu
    </button>
  </nav>
</header>

<!-- Mobile Menu Overlay (z-[60] to sit above navbar z-50) -->
<div
  id="mobile-menu"
  class="fixed inset-0 bg-ivory z-[60] flex flex-col translate-x-full transition-transform duration-400 ease-in-out"
>
  <div class="flex items-center justify-between px-4 pt-4">
    <a href="/" class="font-serif text-[1.4rem] font-medium tracking-[0.12em] text-charcoal">
      {logo ? (
        <img id="mobile-menu-logo-img" src={logo} alt="Gaia Events" class="h-[80px] w-auto object-contain" />
      ) : (
        'GAIA EVENTS'
      )}
    </a>
    <button
      id="mobile-menu-close"
      type="button"
      class="relative w-10 h-10 flex items-center justify-center cursor-pointer"
      aria-label="Chiudi menu"
    >
      <span class="block absolute h-[1.5px] w-6 bg-charcoal rotate-45 pointer-events-none"></span>
      <span class="block absolute h-[1.5px] w-6 bg-charcoal -rotate-45 pointer-events-none"></span>
    </button>
  </div>

  <nav class="flex-1 flex flex-col items-center justify-center gap-8">
    {navLinks.map((link) => (
      <a
        href={link.href}
        class="mobile-nav-link font-serif text-3xl text-charcoal hover:text-bordeaux transition-colors duration-300"
      >
        {link.label}
      </a>
    ))}
    <a
      href="/preventivo"
      class="mt-6 inline-block bg-gold text-charcoal font-sans text-[0.75rem] tracking-[0.15em] uppercase px-10 py-4 hover:bg-gold/90 transition-colors duration-300"
    >
      Parliamone Insieme
    </a>
  </nav>
</div>

<!-- Inline script: theme switching + mobile menu -->
<script is:inline>
  (function() {
    var mobileMenuOpen = false;

    // ─── Theme switching ───
    function applyNavbarTheme() {
      var items = document.querySelectorAll('.navbar-themed');
      var sections = document.querySelectorAll('[data-navbar-theme]');
      var logoImg = document.getElementById('navbar-logo-img');
      var navbarHeight = 112;
      var currentTheme = 'light';

      for (var i = 0; i < sections.length; i++) {
        var rect = sections[i].getBoundingClientRect();
        if (rect.top <= navbarHeight && rect.bottom > navbarHeight) {
          currentTheme = sections[i].getAttribute('data-navbar-theme') || 'light';
        }
      }

      for (var j = 0; j < items.length; j++) {
        if (currentTheme === 'dark') {
          items[j].classList.remove('text-charcoal');
          items[j].classList.add('text-ivory');
        } else {
          items[j].classList.remove('text-ivory');
          items[j].classList.add('text-charcoal');
        }
      }

      // Don't apply invert filter when mobile menu is open (logo should stay dark)
      if (logoImg) {
        if (mobileMenuOpen) {
          logoImg.style.filter = 'none';
        } else {
          logoImg.style.filter = currentTheme === 'dark' ? 'brightness(0) invert(1)' : 'none';
        }
      }
    }

    applyNavbarTheme();
    window.addEventListener('scroll', applyNavbarTheme, { passive: true });
    document.addEventListener('astro:page-load', applyNavbarTheme);
    document.addEventListener('DOMContentLoaded', applyNavbarTheme);

    // ─── Mobile menu ───
    function initMobileMenu() {
      var menuBtn = document.getElementById('mobile-menu-btn');
      var menuClose = document.getElementById('mobile-menu-close');
      var mobileMenu = document.getElementById('mobile-menu');

      if (!menuBtn || !mobileMenu) return;

      // Prevent double-init
      if (menuBtn.dataset.init) return;
      menuBtn.dataset.init = '1';

      function openMenu() {
        mobileMenuOpen = true;
        mobileMenu.classList.remove('translate-x-full');
        mobileMenu.classList.add('translate-x-0');
        menuBtn.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
        // Force navbar logo to dark (no invert) while menu is open
        var logoImg = document.getElementById('navbar-logo-img');
        if (logoImg) logoImg.style.filter = 'none';
      }

      function closeMenu() {
        mobileMenuOpen = false;
        mobileMenu.classList.add('translate-x-full');
        mobileMenu.classList.remove('translate-x-0');
        menuBtn.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        // Re-apply theme-based filter
        applyNavbarTheme();
      }

      menuBtn.addEventListener('click', openMenu);

      if (menuClose) {
        menuClose.addEventListener('click', function(e) {
          e.stopPropagation();
          closeMenu();
        });
      }

      // Close on nav link click (use event delegation on the menu)
      mobileMenu.addEventListener('click', function(e) {
        var target = e.target.closest('a');
        if (target) closeMenu();
      });
    }

    // Run on DOMContentLoaded and astro:page-load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMobileMenu);
    } else {
      initMobileMenu();
    }
    document.addEventListener('astro:page-load', initMobileMenu);
  })();
</script>
